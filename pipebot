#!/bin/env python
import socket, os, select

HOST="irc.zepler.net"
PORT=6667
NICK="pipebot"
IDENT="pipebot"
REALNAME="pipebot"
CHANNEL="#srobo-bots"
PIPE_PATH="/tmp/hash-srobo"

s=socket.socket()
s.connect((HOST, PORT))
s.setblocking(0)

s.send("NICK %s\r\n" % NICK)
s.send("USER %s %s bla :%s\r\n" % (IDENT, HOST, REALNAME))
s.send("JOIN %s\r\n" % CHANNEL)
s.send("PRIVMSG %s %s\r\n" % (CHANNEL, "Ready to plumb.") )

if not os.path.exists(PIPE_PATH):
    os.mkfifo(PIPE_PATH)

irc_buf = ""
pipe_buf = ""

def privmsg(socket, target, msg):
    socket.send( "PRIVMSG %s %s\r\n" % (target, msg) )
    pass

def open_fifo():
    fifofd = os.open( PIPE_PATH,
                      os.O_RDONLY | os.O_NONBLOCK )
    return fifofd

fifofd = open_fifo()

while True:
    ready = select.select( [fifofd,s], [], [fifofd] )

    if s in ready[0]:
        irc_buf += s.recv(100)

        while "\n" in irc_buf:
            lp = irc_buf.find("\n")

            l = irc_buf[0:lp]
            irc_buf = irc_buf[lp+1:]

            print l
            if l[:4] == "PING":
                resp = l.replace( "I", "O", 1 )
                s.send( resp )
                continue

    if fifofd in ready[0]:
        d = os.read(fifofd, 100)
        if len(d) == 0:
            os.close(fifofd)
            fifofd = open_fifo()
            continue

        pipe_buf += d

        while "\n" in pipe_buf:
            nlpos = pipe_buf.find("\n")
            line = pipe_buf[0:nlpos]
            pipe_buf = pipe_buf[nlpos+1:]

            privmsg(s, CHANNEL, line)
